version: '3.8'

services:
  archiver:
    build: .
    image: mingpao-archiver:latest
    volumes:
      - ./data:/data      # Database persistence
      - ./logs:/logs      # Log persistence
    environment:
      - PYTHONUNBUFFERED=1
    # Override command as needed, e.g.:
    # docker-compose run archiver --start 2015-01-01 --end 2015-03-31

  # Helper service to show statistics
  stats:
    build: .
    image: mingpao-archiver:latest
    volumes:
      - ./data:/data
    entrypoint: ["python", "-c"]
    command: |
      import sqlite3
      conn = sqlite3.connect('/data/hkga_archive.db')
      c = conn.cursor()
      c.execute('SELECT status, COUNT(*) FROM archive_records GROUP BY status')
      print('Archive Statistics:')
      for status, count in c.fetchall():
          print(f'  {status}: {count}')
      c.execute('SELECT COUNT(DISTINCT archive_date) FROM archive_records')
      print(f'  Days processed: {c.fetchone()[0]}')
      conn.close()
